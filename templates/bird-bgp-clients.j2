# {{ ansible_managed }}

### Generic Input Filter

filter bgp_in {
 if avoid_martians() && avoid_crappy_prefixes() then accept;
 else reject;
}

### BGP output filter (based on communities)

function bgp_out(int peeras)
{
 if ! (source = RTS_BGP ) then return false;
 if peeras > 65535 then return true; ### communities do not support AS32
 if (0,peeras) ~ bgp_community then return false;
 if (myas,peeras) ~ bgp_community then return true;
 if (0, myas) ~ bgp_community then return false;
 return true;
}

{% if bird_bgp_static_enabled == true %}
protocol static static_bgp {
{% for item in static.values() %}
  import all;         # Import all
  table testtable;    # Connect to a non-default routing table
  check link;         # Advertise routes only if link is up
  route {{ item.ipaddress | indent(2) -}}:{{ item.subnet | indent(2) }} via {{ item.bird_neighbor_ipaddress | indent(2) -}};
{% endfor %}
}
{% endif %}

{% if bird_bgp_rr_enabled == true %}
{% for item in rr.values() %} 
protocol bgp {{ item.bird_friendly_name }} from RR {
    neighbor {{ item.bird_neighbor_ipaddress }} as {{ item.bird_neighbor_asn -}};
    rr cluster id {{ item.bird_cluster_id }};
}
{% endfor %}
{% endif %}

{% if bird_bgp_rs_enabled == true %}
{% for item in rs.values() %} 
protocol bgp {{ item.bird_friendly_name }} from PEERS {
    neighbor {{ item.bird_neighbor_ipaddress }} as {{ item.bird_neighbor_asn -}};
    import filter bgp_in;
    export where bgp_out({{ item.bird_neighbor_asn -}});
}
{% endfor %}
{% endif %}
